# Changelog

## Unreleased

- **Heavy Tasks Queue**: add priority-based queue system for memory/CPU-intensive operations.
  - Implement `HeavyTasksQueueService` using `p-queue` with three priority levels.
  - Priority 0 (highest): EXIF extraction (request-bound, user waits).
  - Priority 1 (medium): Thumbnail generation (request-bound, user waits).
  - Priority 2 (lowest): Lazy image compression (background task).
  - Add `HEAVY_TASKS_MAX_CONCURRENCY` env var to control concurrent heavy tasks (default 4).
  - Add `HEAVY_TASKS_QUEUE_TIMEOUT_MS` env var for task timeout (default 30000ms).
  - Replace `IMAGE_OPTIMIZATION_WAIT_TIMEOUT_MS` with `HEAVY_TASKS_QUEUE_TIMEOUT_MS` for waiting on lazy optimization completion.
  - Prevents server overload by limiting concurrent sharp/exifr operations.
  - Ensures request-bound tasks (EXIF, thumbnails) don't wait for background compression.
- Logging: unify application logs on Pino (nestjs-pino) with structured error fields.
- Env: unify image compression quality/effort settings into `IMAGE_COMPRESSION_QUALITY` and `IMAGE_COMPRESSION_EFFORT` (legacy per-format vars still supported as fallback).
- Compression (breaking): replace `IMAGE_COMPRESSION_MAX_WIDTH`/`IMAGE_COMPRESSION_MAX_HEIGHT` with `IMAGE_COMPRESSION_MAX_DIMENSION` and replace request optimize params `maxWidth`/`maxHeight` with `maxDimension`.
- Compression (breaking): rename env vars to remove DEFAULT suffixes/prefixes:
  - `IMAGE_COMPRESSION_DEFAULT_FORMAT` -> `IMAGE_COMPRESSION_FORMAT`
  - `IMAGE_COMPRESSION_STRIP_METADATA_DEFAULT` -> `IMAGE_COMPRESSION_STRIP_METADATA`
  - `IMAGE_COMPRESSION_LOSSLESS_DEFAULT` -> `IMAGE_COMPRESSION_LOSSLESS`
- Images: add `IMAGE_MAX_BYTES_MB` env var as shared limit for in-memory image processing (EXIF/thumbnails/optimization) and image upload size.
- Thumbnails (breaking): replace `THUMBNAIL_MAX_WIDTH`/`THUMBNAIL_MAX_HEIGHT` with `THUMBNAIL_MAX_DIMENSION`.
- Files: add EXIF extraction (no persistence).
  - Add `GET /api/v1/files/:id/exif` endpoint to extract EXIF for stored images.
  - Remove EXIF extraction from upload response (client should call `/exif` explicitly when needed).
- Shutdown: add `SHUTDOWN_TIMEOUT_MS` env var to limit graceful shutdown wait time for in-flight heavy tasks.
- Errors: harden global exception responses and map Prisma errors to HTTP.
- Cleanup: comprehensive cleanup service with TTL-based policies for bad status files and old thumbnails.
  - Add `statusChangedAt` field to track when file status changes.
  - Replace `CLEANUP_ORPHAN_TIMEOUT_MINUTES` with `CLEANUP_BAD_STATUS_TTL_DAYS` (default 7 days).
  - Add `THUMBNAIL_MAX_AGE_DAYS` for unused thumbnail cleanup and thumbnail cache max-age (default 90 days).
  - Add `CLEANUP_BATCH_SIZE` for controlling cleanup batch operations.
  - Unified cleanup pipeline: corrupted records, bad status files, and old thumbnails.
  - Cleanup: add S3 cleanup for `tmp/` and `originals/` prefixes using `ListObjectsV2` with TTL policies.
  - Cleanup: treat `NULL` `s3_key` / `mime_type` in READY rows as corrupted.
  - Cleanup: make retry deletion for stuck `deleting` rows use full cleanup logic (file + original + thumbnails).
- Files: harden download headers and improve deduplication behavior.
  - **Fix**: Handle deduplication race conditions in image optimization pipeline (`optimizeImage`).
  - **Fix**: Ensure temporary objects (`tmp/`, `originals/`) are cleaned up via cleanup job to reduce storage waste.
  - **Enhancement**: Pre-check for existing optimized content before upload to avoid duplicate work.
  - **Enhancement**: Graceful handling of P2002 unique constraint violations during concurrent uploads.
  - **Enhancement**: Improved error logging for deduplication and cleanup operations.
  - Prisma: deduplication uses a partial unique index for active READY files (allows re-upload after soft delete).
- **Files: add optional tagging support** (`appId`, `userId`, `purpose`).
  - Add nullable `appId`, `userId`, `purpose` fields to File model with indexes for filtering.
  - Support multipart fields `appId`, `userId`, `purpose` on upload (`POST /api/v1/files`).
  - Expose tags in file response DTO and list endpoint (`GET /api/v1/files`).
  - Add `POST /api/v1/files/bulk-delete` endpoint for mass soft delete by tags (requires at least one tag filter).
  - Update UI to display tags and support bulk delete by tag filters.
- Cleanup: rely on cleanup job expiration for `tmp/` and `originals/` objects.
- Prisma: upgrade to Prisma v7 and add `prisma.config.ts`.
- Env: unify Prisma CLI and NestJS env loading via `dotenv-cli` and `.env.*` files.
