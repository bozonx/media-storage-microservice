# Changelog

## Unreleased

- **Images**: delegate image optimization, thumbnail generation, and EXIF extraction to external Image Processing microservice.
  - Public API remains unchanged (clients do not need to update).
  - Replace local `sharp`/`exifr` processing and in-process heavy tasks queue with HTTP calls.
  - Add env vars: `IMAGE_PROCESSING_BASE_URL`, `IMAGE_PROCESSING_REQUEST_TIMEOUT_SECONDS` (in seconds).
- **Fix**: resolve missing dependencies in `HealthModule` and update E2E tests to match new health response structure.
- Logging: unify application logs on Pino (nestjs-pino) with structured error fields.
- Env: unify image compression quality/effort settings into `IMAGE_COMPRESSION_QUALITY` and `IMAGE_COMPRESSION_EFFORT`.
- Compression (breaking): replace `IMAGE_COMPRESSION_MAX_WIDTH`/`IMAGE_COMPRESSION_MAX_HEIGHT` with `IMAGE_COMPRESSION_MAX_DIMENSION` and replace request optimize params `maxWidth`/`maxHeight` with `maxDimension`.
- Compression (breaking): rename env vars to remove DEFAULT suffixes/prefixes:
  - `IMAGE_COMPRESSION_DEFAULT_FORMAT` -> `IMAGE_COMPRESSION_FORMAT`
  - `IMAGE_COMPRESSION_STRIP_METADATA_DEFAULT` -> `IMAGE_COMPRESSION_STRIP_METADATA`
  - `IMAGE_COMPRESSION_LOSSLESS_DEFAULT` -> `IMAGE_COMPRESSION_LOSSLESS`
- Images: add `IMAGE_MAX_BYTES_MB` env var as shared limit for in-memory image processing (EXIF/thumbnails/optimization) and image upload size.
- Thumbnails (breaking): replace `THUMBNAIL_MAX_WIDTH`/`THUMBNAIL_MAX_HEIGHT` with `THUMBNAIL_MAX_DIMENSION`.
- Files: add EXIF extraction (no persistence).
  - Add `GET /api/v1/files/:id/exif` endpoint to extract EXIF for stored images.
  - Remove EXIF extraction from upload response (client should call `/exif` explicitly when needed).
- Shutdown: add `SHUTDOWN_TIMEOUT_SECONDS` env var to limit graceful shutdown wait time for in-flight heavy tasks (in seconds).
- Errors: harden global exception responses and map Prisma errors to HTTP.
- Cleanup: comprehensive cleanup service with TTL-based policies for bad status files and old thumbnails.
  - Add `statusChangedAt` field to track when file status changes.
  - Replace `CLEANUP_ORPHAN_TIMEOUT_MINUTES` with `CLEANUP_BAD_STATUS_TTL_DAYS` (default 7 days).
  - Add `THUMBNAIL_MAX_AGE_DAYS` for unused thumbnail cleanup and thumbnail cache max-age (default 90 days).
  - Add `CLEANUP_BATCH_SIZE` for controlling cleanup batch operations.
  - Unified cleanup pipeline: corrupted records, bad status files, and old thumbnails.
  - Cleanup: add S3 cleanup for `tmp/` and `originals/` prefixes using `ListObjectsV2` with TTL policies.
  - Cleanup: treat `NULL` `s3_key` / `mime_type` in READY rows as corrupted.
  - Cleanup: make retry deletion for stuck `deleting` rows use full cleanup logic (file + original + thumbnails).
  - Cleanup: add claim + backoff for soft-deleted cleanup to prevent tight retry loops.
    - Add `CLEANUP_SOFT_DELETED_RETRY_DELAY_MINUTES` (default 30).
    - Add `CLEANUP_SOFT_DELETED_STUCK_WARN_DAYS` (default 3).
- Files: harden download headers and improve deduplication behavior.
  - **Fix**: Handle deduplication race conditions in image optimization pipeline (`optimizeImage`).
  - **Fix**: Ensure temporary objects (`tmp/`, `originals/`) are cleaned up via cleanup job to reduce storage waste.
  - **Enhancement**: Pre-check for existing optimized content before upload to avoid duplicate work.
  - **Enhancement**: Graceful handling of P2002 unique constraint violations during concurrent uploads.
  - **Enhancement**: Improved error logging for deduplication and cleanup operations.
  - Prisma: deduplication uses a partial unique index for active READY files (allows re-upload after soft delete).
- **Files: add optional tagging support** (`appId`, `userId`, `purpose`).
  - Add nullable `appId`, `userId`, `purpose` fields to File model with indexes for filtering.
  - Support multipart fields `appId`, `userId`, `purpose` on upload (`POST /api/v1/files`).
  - Expose tags in file response DTO and list endpoint (`GET /api/v1/files`).
  - Add `POST /api/v1/files/bulk-delete` endpoint for mass soft delete by tags (requires at least one tag filter).
  - Update UI to display tags and support bulk delete by tag filters.
- **Files: add upload from URL** (`POST /api/v1/files/from-url`).
  - Adds SSRF protections (HTTPS-only, blocks localhost/local DNS names/private IP ranges by default).
  - Adds env vars: `URL_UPLOAD_BLOCK_UNSAFE_CONNECTIONS`, `URL_UPLOAD_TIMEOUT_MS`, `URL_UPLOAD_MAX_BYTES_MB`, `URL_UPLOAD_MAX_REDIRECTS`.
- Cleanup: rely on cleanup job expiration for `tmp/` and `originals/` objects.
- Prisma: upgrade to Prisma v7 and add `prisma.config.ts`.
- Env: unify Prisma CLI and NestJS env loading via `dotenv-cli` and `.env.*` files.
